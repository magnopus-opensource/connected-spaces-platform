name: Update Changelog on TeamCity Publish

on:
  repository_dispatch:
    # This workflow listens for a custom event type triggered by TeamCity as part of the 'Publish CSP' build step
    types: [release-published]

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Configure Git
        run: |
          git config user.name "${{ secrets.GH_AUTOMATON_USERNAME }}"
          git config user.email "${{ secrets.GH_AUTOMATON_EMAIL }}"
          git pull

      - name: Get Release Version and Date from Payload
        id: get_release_info
        run: |
          # The client_payload of the TeamCity 'repository_dispatch' event will contain the version and date of the published release
          RELEASE_VERSION="${{ github.event.client_payload.version }}"
          RELEASE_DATE="${{ github.event.client_payload.date }}"
          
          # Validate that a release version was provided
          if [ -z "$RELEASE_VERSION" ]; then
            echo "::error::Release version not provided in repository_dispatch payload."
            exit 1
          fi

          # Validate that a release date was provided
          if [ -z "$RELEASE_DATE" ]; then
            echo "::error::Release date not provided in repository_dispatch payload."
            exit 1
          fi

          echo "Specified Release Version: $RELEASE_VERSION"
          echo "Specified Release Date: $RELEASE_DATE"

          echo "RELEASE_VERSION=$RELEASE_VERSION" >> $GITHUB_OUTPUT
          echo "RELEASE_DATE=$RELEASE_DATE" >> $GITHUB_OUTPUT

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'

      - name: Update CHANGELOG.md using Python
        # The step Id is used in the next step to reference the python scripts output for 'changelog_updated'
        id: update_changelog_script
        run: |
          python .github/scripts/update_changelog_release_tag.py \
            "${{ steps.get_release_info.outputs.RELEASE_VERSION }}" \
            "${{ steps.get_release_info.outputs.RELEASE_DATE }}" \
            ".github/CHANGELOG.md"

      - name: Commit and Push Changes
        # Only commit and push if the changelog was updated
        # The changelog_updated output value is set by the Python script which is executed in the 'update_changelog_script' step
        if: ${{ steps.update_changelog_script.outputs.changelog_updated == 'true' }}
        run: |
          git add ".github/CHANGELOG.md"
          git commit -m "Update CHANGELOG.md for release ${{ steps.get_release_info.outputs.RELEASE_VERSION }}" --no-verify
          git push