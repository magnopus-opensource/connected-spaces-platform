# CSP Wasm Testing

This directory contains tests for CSP when compiled under WASM, using our autogenerated TS/JS bindings.
There are some unique behaviours when running under WASM, and especially when running in a browser, that we want to be able to test. The most notable one being the different event model browsers have, which can manifest awful bugs such as the infamous `table index out of bounds` when attempting to call functor like objects across different threads.

These tests use the `uvu` test framework, and leverage `puppeteer` to launch a headless browser, run tests, and then assert behavior, mostly based on browser logs and errors from the developer console.

Puppeteer is being leveraged here specifically to replicate a user environment, a browser, as close as possible. Running tests inside a browser is more complex, but that is the cost.

## Running the tests
To run, call `./run-csp-wasm-tests.cmd`

> [!NOTE]  
> The test script attempts to install `caddy`, a webserver via `chocolatey`. If you have not installed `caddy` before, this will require administrator privileges. If you already have installed it and are not running an administrator shell, the script will complain that you're not in an administrator context, but will work fine otherwise.

## CSP
To run the tests, you need to have WASM CSP already built in the project directory. The test script will automatically grab it from the appropriate location and copy it here. To do this, navigate to `connected-spaces-platform/Tools/Emscripten` and run `./EmscriptenFullBuildAndConfigure debug withNode`.

Note the `withNode` arg, this is important for this test framework. 

You will also note the `const USE_DEBUG_CSP: boolean` field in the main test file. This defines whether you are running in debug or release mode. It is important to have built the appropriate version. The script will grab whatever happens to be in the WASM package directory, which can have old versions of debug/release in if you haven't cleaned it or built recently. Be aware.

## Local fileserver

These tests leverage a local file server, `caddy`, to serve the files in the `html_tests` directory to `127.0.0.1:8888`. The tests then launch those pages in a headless browser via puppeteer in order to run test behavior.

> [!NOTE]  
> The reason this is done is because trying to get a browser to let you make web requests from a WASM context whilst using the `file://` protocol seems to be almost impossible. Using a local webserver allows us to send the correct CORS headers whilst using an acceptable protocol.

This server is launched automatically in the test script.

## Shared JS
As we want to be able to write test code both in the node out-of-browser context, and inside the browser, we need to serve the code the browser will run via the fileserver.

This is all well and good, but if we did that naively, we would end up duplicating a lot of code, specifically the initialization code that has to be called to load the library every time.

This is why, if you look at the test script, we create junctions (symlinks) from the `html_tests` dir to shared code and dependencies. This allows us to have the same source files without duplication, whilst allowing them to be used both in the node context, and in the browser.