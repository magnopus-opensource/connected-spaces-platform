<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin">
    <meta http-equiv="Cross-Origin-Embedder-Policy" content="require-corp">
    <meta charset="utf-8">
    <title>CSP WASM Browser Test, EnterSpaceFromCheckpoint</title>
    <script type="module">
      import { ready, CSPFoundation, Systems, Multiplayer, Common } from './node_modules/connected-spaces-platform.web/connectedspacesplatform.js';
      import { initializeCSP } from './shared/csp-initializer.js';
      (async () => {
        const params = new URLSearchParams(window.location.search);
        const useDebugCSP = params.get('useDebugCsp');

        await initializeCSP(useDebugCSP);

        const systemsManager = Systems.SystemsManager.get();
        const userSystem = systemsManager.getUserSystem();

        //Login as a guest, without a SignalR connection
        const loginResult = await userSystem.loginAsGuest(false, true);
        if (loginResult.getResultCode() == Systems.EResultCode.Success){
          console.log("Successfully logged in");
        }
        else {
          console.error("Failed to log in");
        }

        async function loadJsonString() {
          const response = await fetch('./shared/testdata/checkpoint-large.json');  
          if (!response.ok) {
            throw new Error(`Failed to load file: ${response.status}`);
          }
          return await response.text(); 
        }

        // Split the json string and construct the scene representation objects
        const jsonString = await loadJsonString();
        const jsonStringList = Common.List.ofString()
        for (const ch of jsonString){ jsonStringList.append(ch); }

        let sceneData = Systems.CSPSceneData.create_sceneDescriptionJson(jsonStringList);
        let sceneDescription = Multiplayer.CSPSceneDescription.create_sceneDescriptionJson(jsonStringList);

        jsonStringList.delete();
        
        //Create offline realtime engine
        const realtimeEngine = Multiplayer.OfflineRealtimeEngine.create_sceneDescription_logSystem_remoteScriptRunner(
          sceneDescription,
          systemsManager.getLogSystem(),
          systemsManager.getScriptSystem()
        );

        realtimeEngine.setEntityFetchCompleteCallback((entitiesFetchedNum) => {})

        //Enter the space
        const spaceSystem = Systems.SystemsManager.get().getSpaceSystem();
        const enterSpaceResult = await spaceSystem.enterSpace("Offline Space", realtimeEngine);

        if (enterSpaceResult.getResultCode() == Systems.EResultCode.Success){
          console.log("Successfully entered space");
        }
        else {
          console.error("Failed to enter space");
        }

        //Do something to exercise the engine
        const authState = loginResult.getLoginState();
        const playerTransform = Multiplayer.SpaceTransform.create();

        const entity = await realtimeEngine.createAvatar(
          'Offline Player',
          authState.userId,
          playerTransform,
          true,
          Multiplayer.AvatarState.Idle,
          authState.userId,
          Multiplayer.AvatarPlayMode.Default
        );

        if (entity != null){
          console.log("Successfully created avatar");
        }
        else {
          console.error("Failed to create avatar");
        }

        loginResult.delete();
        enterSpaceResult.delete(); 

        //Exit the space
        const exitSpaceResult = await spaceSystem.exitSpace();

        //Delete the realtime engine now that we've exited the space
        realtimeEngine.delete();
        
        
      })();
    </script>
  </head>
  <body>
    <h1>Running CSP WASM browser testâ€¦</h1>
  </body>
</html>